package com.clush.service;

import java.util.Calendar;
import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.clush.dto.ToDoDto;
import com.clush.entity.CalendarEntity;
import com.clush.entity.TodoEntity;
import com.clush.respository.CalendarRepository;
import com.clush.respository.ToDoRepository;

@Service
public class ToDoService {

	@Autowired
	private ToDoRepository toDoRepository;
	@Autowired
	private CalendarRepository calendarRepository;
	
	public ResponseEntity<List<TodoEntity>> getTodayToDoService() {
        // 오늘 날짜 구하기 (시간 제외)
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 0);
        calendar.set(Calendar.MINUTE, 0);
        calendar.set(Calendar.SECOND, 0);
        calendar.set(Calendar.MILLISECOND, 0);
        Date today = calendar.getTime();
        System.out.println(today.toString());
        
        // 오늘 날짜에 해당하는 ToDo 조회
        List<TodoEntity> todayToDos = toDoRepository.findByDate(today.toString());

        if (todayToDos.isEmpty()) {
            return ResponseEntity.noContent().build();
        }

        return ResponseEntity.ok(todayToDos);
    }
	
	public ResponseEntity<Void> saveToDoService(ToDoDto toDoDto){
		
		//추가된 작업의 날짜에 해당하는 캘린더 Entity 호출
	    CalendarEntity calendarEntity = calendarRepository.findByDate(toDoDto.getDate());
	    
	    if (calendarEntity == null) { // 없으면 추가

	        calendarEntity = new CalendarEntity();
	        calendarEntity.setDate(toDoDto.getDate());
	    }
	    
	    TodoEntity todoEntity = new TodoEntity(toDoDto);
	    	   
	    todoEntity.setCalendar(calendarEntity); 
	    calendarEntity.getTodos().add(todoEntity); 
	    
	    calendarRepository.save(calendarEntity);
		
		return ResponseEntity.ok().build();
	}
	
}
